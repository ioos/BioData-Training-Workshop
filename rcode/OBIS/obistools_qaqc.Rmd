---
title: "OBIS tools for QA/QC"
author: "Samuel Bosch"
date: "2018-02-09"
output: 
  ioslides_presentation:
    css: obis.css
    smaller: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(obistools)
```

## Getting started

Installation

```{r installation, eval=FALSE}
# install.packages("devtools")
devtools::install_github('iobis/obistools')

library(obistools)
```

Help and issues

- Manual: <http://www.iobis.org/manual/processing/>
- Issues: <https://github.com/iobis/obistools/issues>

## Generate a report

View points on a map and check missing fields, event dates, depth values, points on land, ...

```{r report, eval=FALSE, message=FALSE}
report(abra, file="abra_report.html", dir=".")
```

[abra_report.html](abra_report.html)
  
<center><img src="abra_report.png" height="400px" width="auto" style="display:block" /></center>

## Check required fields

```{r check_fields}
check_fields(abra)
```

occurrenceStatus: A statement about the presence or absence of a Taxon at a Location.  
<http://rs.tdwg.org/dwc/terms/#occurrenceStatus>

## Map column names to Darwin Core terms

```{r map_fields}
data <- data.frame(
  id = c("cruise_1", "station_1", "station_2", "sample_1", "sample_2", "sample_3", "sample_4", "subsample_1", "subsample_2"),
  date = c(NA, NA, NA, "2017-01-01", "2017-01-02", "2017-01-03", "2017-01-04", NA, NA),
  locality = rep("North Sea", 9),
  lon = c(NA, 2.9, 4.7, NA, NA, NA, NA, NA, NA),
  lat = c(NA, 54.1, 55.8, NA, NA, NA, NA, NA, NA),
  stringsAsFactors = FALSE)

mapping <- list(
  decimalLongitude = "lon", decimalLatitude = "lat",
  datasetName = "dataset", eventID = "id", eventDate = "date")
```

[Issue 56: detect_fields](https://github.com/iobis/obistools/issues/56)

---
```{r map_fields_result, eval=TRUE}
map_fields(data, mapping)
```

## Taxon matching

Interactive taxon matching with the World Register of Marine Species (WoRMS)

```{r, eval=FALSE}
taxa <- c("Abra alva", "Buccinum fusiforme", "Buccinum fusiforme", "hlqsdkf")
matched_taxa <- match_taxa(taxa)
matched_taxa
```
```
3 names, 1 without matches, 1 with multiple matches
Proceed to resolve names (y/n/p)? y

  AphiaID     scientificname      authority     status match_type
1  531014 Buccinum fusiforme   Kiener, 1834 unaccepted      exact
2  510389 Buccinum fusiforme Broderip, 1830 unaccepted      exact

Multiple matches, pick a number or leave empty to skip: 2
```
```{r, echo=FALSE}
matched_taxa <- data.frame(scientificName=c('Abra alba', rep('Buccinum fusiforme', 2), NA), scientificNameID=c('urn:lsid:marinespecies.org:taxname:141433', rep('urn:lsid:marinespecies.org:taxname:510389',2), NA), matche_type=c('near_1', rep('exact',2), NA))
matched_taxa
```

## Checking points on land

```{r}
onland <- check_onland(abra)
onland[,1:5]
plot_map(onland, zoom = TRUE)
```

---

```{r, fig.height=6, fig.width=8}
robis::leafletmap(onland)
```


## Checking depth values

```{r}
depthreport <- check_depth(abra, report = TRUE)
depthreport[1:10, ]

```

## Check event date

```{r}
data_nodate <- data.frame(
  scientificName = c("Abra alba", "Lanice conchilega"),
  stringsAsFactors = FALSE)

check_eventdate(data_nodate)
```

---
```{r}
data_goodformats <- data.frame(
  eventDate = c(
    "2016",
    "2016-01",
    "2016-01-02",
    "2016-01-02 13:00",
    "2016-01-02T13:00",
    "2016-01-02 13:00:00/2016-01-02 14:00:00",
    "2016-01-02 13:00:00/14:00:00"), 
  stringsAsFactors = FALSE)

check_eventdate(data_goodformats)
```

---
```{r}
data_badformats <- data.frame(
  eventDate = c(
    "2016/01/02",
    "2016-01-02 13h00"),
  stringsAsFactors = FALSE)

check_eventdate(data_badformats)
```

## Check eventID and parentEventID

```{r}
```

## Check eventID in an extension

```{r}
```

## Flatten event records

```{r}
```

## Flatten occurrence and event records

```{r}
```

## Calculate centroid and radius for WKT geometries

```{r}
```

